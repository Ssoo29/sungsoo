--1

SELECT COUNT(*)
FROM TB_BOOK
LEFT JOIN TB_PUBLISHER USING(PUBLISHER_NM)
LEFT JOIN TB_BOOK_AUTHOR USING(BOOK_NO)
LEFT JOIN TB_WRITER USING(WRITER_NO);


--2
SELECT TABLE_NAME, COLUMN_NAME, DATA_TYPE, DATA_DEFAULT, NULLABLE, CONSTRAINT_NAME, CONSTRAINT_TYPE,
        R_CONSTRAINT_NAME
FROM USER_CONSTRAINTS
JOIN USER_TAB_COLUMNS USING(TABLE_NAME);

--3
SELECT BOOK_NO, BOOK_NM
FROM TB_BOOK
WHERE LENGTH(BOOK_NM) >= 25;

--4
SELECT WRITER_NM, OFFICE_TELNO, HOME_TELNO, MOBILE_NO
FROM TB_WRITER
WHERE MOBILE_NO LIKE '019%' AND WRITER_NM LIKE '김%';

--5
SELECT COUNT(DISTINCT WRITER_NO)
FROM TB_BOOK_AUTHOR
WHERE COMPOSE_TYPE = '옮김';

--6
SELECT COMPOSE_TYPE, COUNT(*)
FROM TB_BOOK_AUTHOR
WHERE COMPOSE_TYPE IS NOT NULL
GROUP BY COMPOSE_TYPE
HAVING COUNT(*) >= 300;


--7
SELECT B BOOK_NM, P PUBLISHER_NM, A ISSUDATE 
FROM ( SELECT ISSUE_DATE A, BOOK_NM B, PUBLISHER_NM P
       FROM TB_BOOK
       ORDER BY 1 DESC)
WHERE ROWNUM = 1;

SELECT BOOK_NM, PUBLISHER_NM, RANK () OVER (ORDER BY ISSUE_DATE DESC)
FROM TB_BOOK;
--WHERE ROWNUM = 1;

--8
SELECT *
FROM ( SELECT WRITER_NM "작가 이름", COUNT(*) "권 수"
       FROM TB_BOOK_AUTHOR
       JOIN TB_WRITER USING(WRITER_NO)
       GROUP BY WRITER_NM
       ORDER BY 2 DESC)
WHERE ROWNUM <= 3;

--9

UPDATE TB_WRITER A
SET REGIST_DATE =(SELECT MIN(ISSUE_DATE)
                  FROM TB_BOOK
                  JOIN TB_BOOK_AUTHOR USING (BOOK_NO)
                  JOIN TB_WRITER USING(WRITER_NO)
                  WHERE A.WRITER_NM = WRITER_NM
                  GROUP BY WRITER_NM);
                  
                  
--SELECT MIN(ISSUE_DATE), WRITER_NM
--                  FROM TB_BOOK
--                  JOIN TB_BOOK_AUTHOR USING (BOOK_NO)
--                  JOIN TB_WRITER USING(WRITER_NO)
--                  GROUP BY WRITER_NM;
        
COMMIT;

--10
CREATE TABLE TB_BOOK_TRANSLATOR(
BOOK_NO VARCHAR2(10),
WRITER_NO VARCHAR2(10),
TRANS_LANG VARCHAR2(60),

CONSTRAINT PK_BOOK_TRANSLATOR PRIMARY KEY (BOOK_NO, WRITER_NO),
CONSTRAINT PK_BOOK_TRANSLATOR_01 FOREIGN KEY (BOOK_NO) REFERENCES TB_BOOK(BOOK_NO),
CONSTRAINT PK_BOOK_TRANSLATOR_02 FOREIGN KEY (WRITER_NO) REFERENCES TB_WRITER(WRITER_NO)
);

COMMENT ON COLUMN TB_BOOK_TRANSLATOR.BOOK_NO IS '도서 번호';
COMMENT ON COLUMN TB_BOOK_TRANSLATOR.WRITER_NO IS '작가 번호';
COMMENT ON COLUMN TB_BOOK_TRANSLATOR.TRANS_LANG IS '번역 언어';


--11

INSERT INTO TB_BOOK_TRANSLATOR(BOOK_NO, WRITER_NO, TRANS_LANG)
(SELECT BOOK_NO, WRITER_NO, COMPOSE_TYPE
 FROM TB_BOOK_AUTHOR
 WHERE COMPOSE_TYPE IN ('옮김', '역주', '편역', '공역'));

DELETE FROM TB_BOOK_AUTHOR
WHERE COMPOSE_TYPE IN ('옮김', '역주', '편역', '공역');

ROLLBACK;

--12
SELECT BOOK_NM, WRITER_NM, ISSUE_DATE
FROM TB_BOOK
JOIN TB_BOOK_TRANSLATOR USING(BOOK_NO)
JOIN TB_WRITER USING(WRITER_NO)
WHERE BOOK_NO LIKE '2007%';


--13
CREATE VIEW VW_BOOK_TRANSLATOR
AS SELECT BOOK_NM, WRITER_NM, ISSUE_DATE
   FROM TB_BOOK
   JOIN TB_BOOK_TRANSLATOR USING(BOOK_NO)
   JOIN TB_WRITER USING(WRITER_NO)
   WHERE BOOK_NO LIKE '2007%'
WITH READ ONLY;


SELECT * FROM VW_BOOK_TRANSLATOR;


--14
INSERT INTO TB_PUBLISHER
VALUES('춘 출판사', '02-2710-3737', DEFAULT);

--15
SELECT WRITER_NM, COUNT(*)
FROM TB_WRITER
GROUP BY WRITER_NM
HAVING COUNT(*) > 1;

--16
UPDATE TB_BOOK_AUTHOR
SET COMPOSE_TYPE = '지음'
WHERE COMPOSE_TYPE IS NULL;


--17
SELECT WRITER_NM, OFFICE_TELNO
FROM TB_WRITER
WHERE OFFICE_TELNO LIKE '02-___-%';

--18
SELECT WRITER_NM
FROM TB_WRITER
WHERE MONTHS_BETWEEN(TO_DATE('200601', 'RRRRMM'), REGIST_DATE) <= 31
ORDER BY 1;


--19
SELECT BOOK_NM, PRICE, CASE WHEN STOCK_QTY < 5 THEN '추가주문필요' ELSE '소량보유' END
FROM TB_BOOK
WHERE PUBLISHER_NM = '황금가지' AND STOCK_QTY < 10;


--20
SELECT BOOK_NM 도서명, WRITER_NM 저자, (SELECT WRITER_NM
                                       FROM TB_WRITER
                                       JOIN TB_BOOK_TRANSLATOR USING(WRITER_NO)
                                       WHERE BOOK_NO = (SELECT BOOK_NO
                                              FROM TB_BOOK
                                              WHERE BOOK_NM = '아타트롤')) 역자
FROM TB_BOOK
JOIN TB_BOOK_AUTHOR USING(BOOK_NO)
JOIN TB_WRITER USING(WRITER_NO)
WHERE BOOK_NO = (SELECT BOOK_NO
                 FROM TB_BOOK
                 WHERE BOOK_NM = '아타트롤');

DELETE 

--21
SELECT BOOK_NM 도서명, STOCK_QTY 재고수량, PRICE AS "가격(org)", PRICE + PRICE*0.2 AS "가격(new)"
FROM TB_BOOK
WHERE MONTHS_BETWEEN(ISSUE_DATE, SYSDATE)/12 <= 30
ORDER BY 2 DESC, 4 DESC, 1 DESC;
